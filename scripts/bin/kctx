#!/usr/bin/env bash

function main() {
  local kubeconfig=${ROOT_KUBECONFIG:-$KUBECONFIG}
  local arg1="$1"
  local arg2="$2"
  local is_ctx_selected=false
  if [[ -z $arg1 || $arg1 =~ ^--kubeconfig ]]
  then
    export ROOT_KUBECONFIG=${kubeconfig}
    kubie ctx --kubeconfig=${kubeconfig}
    is_ctx_selected=true
  elif [[ ! $arg1 =~ ^- && $arg2 == "-e" ]]; then
    local selected_config="$KUBECONFIGS_DIR/$arg1"
    if [[ ! -f $selected_config ]]; then
      >&2 echo "Error: no Kubeconfig file \"$arg1\" in $KUBECONFIGS_DIR"
      exit 1
    fi
    export ROOT_KUBECONFIG=$selected_config
    kubie ctx --kubeconfig=$ROOT_KUBECONFIG
    is_ctx_selected=true
  elif [[ ! $arg1 =~ ^- || $arg1 == "-l" ]]; then
    qstring="$@"

    if [[ -f "$KUBECONFIGS_DIR/$arg1" ]]; then
      kctx $arg1 -e
    elif [[ $arg1 == "-l" ]]; then
      qstring=""
    fi
    local selected_config=$(ls ~/.kube/config-files | fzf -q "$qstring" -1)
    if [ -z "$selected_config" ]; then
      exit 0
    fi
    export ROOT_KUBECONFIG=$KUBECONFIGS_DIR/$selected_config
    kubie ctx --kubeconfig=$ROOT_KUBECONFIG
  elif [[ $arg1 == "-c" ]]; then
    kubectl config current-context
  else
    kubie ctx ${@} --kubeconfig=${kubeconfig}
  fi
}

main "$@"