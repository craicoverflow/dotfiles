#!/bin/sh

function main() {
  local kubeconfig=${ROOT_KUBECONFIG:-$KUBECONFIG}
  if [[ -z "$1" || "$1" =~ ^--kubeconfig ]]
  then
    export ROOT_KUBECONFIG=${kubeconfig}
    kubie ctx --kubeconfig=${kubeconfig}
  elif [[ ! "$1" =~ ^- && "$2" == "-e" ]]; then
    local selected_config="$KUBECONFIGS_DIR/$1"
    if [[ ! -f $selected_config ]]; then
      >&2 echo "Error: no Kubeconfig file \"$1\" in $KUBECONFIGS_DIR"
      exit 1
    fi
    export ROOT_KUBECONFIG=$selected_config
    kubie ctx --kubeconfig=$ROOT_KUBECONFIG
  elif [[ ! "$1" =~ ^- || "$1" == "-l" ]]; then
    qstring="$@"
    if [[ "$1" == "-l" ]]; then
      qstring=""
    fi
    local selected_config=$(ls ~/.kube/config-files | fzf -q "$qstring" -1)
    if [ -z "$selected_config" ]; then
      exit 0
    fi
    export ROOT_KUBECONFIG=$KUBECONFIGS_DIR/$selected_config
    kubie ctx --kubeconfig=$ROOT_KUBECONFIG
  elif [[ "$1" == "-c" ]]; then
    kubectl config current-context
  else
    kubie ctx ${@} --kubeconfig=${kubeconfig}
  fi
}

main "$@"